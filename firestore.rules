/**
 * Core Philosophy: This ruleset implements a Role-Based Access Control (RBAC) model.
 * A global 'Admin' role grants full write permissions across the database, while
 * general authenticated users are granted read-only access to public data and write
 * access to their own user profile.
 *
 * Data Structure:
 * - /roles_admin/{uid}: A collection where the existence of a document signifies
 *   that the user with the corresponding UID is a global administrator.
 * - /dashboardLinks/{dashboardLinkId}: A collection of link documents.
 * - /users/{uid}: Stores public user profile information.
 * - /internal/seedMarker: A document to track if initial data has been seeded.
 *
 * Key Security Decisions:
 * - Admin Supremacy: Users in `/roles_admin` can manage all data.
 * - One-Time Seeding: Any authenticated user can perform the initial data seed if it hasn't been done.
 * - User Self-Management: Authenticated users can create and update their own
 *   profile document in the `/users` collection, but cannot edit others'.
 * - Read-Only for Public Data: Regular authenticated users can read dashboard links.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for readable, reusable logic.
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return request.auth.uid == uid;
    }

    function isAdmin() {
      // Check if a document for the user exists in the admin roles collection.
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
    
    // This function checks if the database has been seeded before.
    function isSeeding() {
        return !exists(/databases/$(database)/documents/internal/seedMarker);
    }

    match /roles_admin/{uid} {
      allow read, write: if isAdmin();
    }
    
    match /internal/seedMarker {
      // Any signed in user can read the marker to see if seeding is needed.
      allow read: if isSignedIn();
      // Only admins can write to the marker, which happens during seeding.
      allow write: if isAdmin();
    }

    match /dashboardLinks/{linkId} {
      // Any signed-in user can read the links.
      allow get, list: if isSignedIn();
      
      // Only Admins can write to dashboard links.
      allow write: if isAdmin();
    }

    /**
     * @description Manages access to user profile documents. Users can create and
     *              update their own profile, while admins can manage any profile.
     * @path /users/{uid}
     * @allow An authenticated user (e.g., auth.uid = 'user_abc') creating their own profile ((create) /users/user_abc).
     * @deny A user trying to read or write another user's profile.
     * @principle Enables user self-service for profile management while maintaining privacy.
     */
    match /users/{uid} {
       allow read, create, update: if isSignedIn() && isOwner(uid);
       allow delete: if isAdmin(); // Only admins can delete user profiles
    }
  }
}
